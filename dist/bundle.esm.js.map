{"version":3,"file":"bundle.esm.js","sources":["../src/index.js"],"sourcesContent":["import _ from 'lodash';\nimport Promise from 'bluebird';\n\nexport function wrapAct() {\n  if (!this.seneca) {\n    throw new Error('no seneca found');\n  }\n\n  if (!global.Errors) {\n    throw new Error('no global Errors found');\n  }\n  let act = Promise.promisify(this.seneca.act, { context: this.seneca });\n\n  // expose global promise act\n  global.act = async function actAsync(msg, ...args) {\n    if (global.als) {\n      let traceId = global.als.get('traceId');\n      msg.traceId = msg.traceId === undefined ? traceId : msg.traceId;\n    }\n\n    return act(msg, ...args).then((result) => {\n      if (result && result.error && result.code && result.name) {\n        if (!Errors[result.name]) {\n          return Promise.reject(new Error(`no error name found ${result.name} for ${result.error}`));\n        }\n\n        return Promise.reject(new Errors[result.name]());\n      }\n      return result;\n    });\n  };\n}\n\nexport function wrapRoutes() {\n  if (!this.seneca) {\n    throw new Error('no seneca found');\n  }\n\n  this.seneca.plainMsg = function plainMsg(msg) {\n    return _.omit(msg, [\n      'cmd',\n      'action',\n      'role',\n      'transport$',\n      'id$',\n      'plugin$',\n      'fatal$',\n      'tx$',\n      'meta$',\n      'traceId',\n    ]);\n  };\n\n  _.forEach(this.config.routes, (action, key) => {\n    let index = key.indexOf(' ');\n    let keyParts = [key.slice(0, index), key.slice(index + 1)];\n    let method = (keyParts[0] || '').toLowerCase();\n\n    if (!_.includes(['add', 'wrap'], method)) {\n      throw new Error(`invalid route method: ${method}`);\n    }\n\n    let actionParts = action.split('.');\n    let controllerName = actionParts[0];\n    let controller = this.controllers[controllerName];\n    if (!controller) {\n      throw new Error(`undefined controller: ${controllerName}`);\n    }\n\n    let actionMethodName = actionParts[1];\n    let actionMethod = controller[actionMethodName].bind(controller);\n    if (!actionMethod) {\n      throw new Error(`undefined action method: ${action}`);\n    }\n\n    controller[actionMethodName] = function actionAsync(msg, done) {\n      let { traceId } = msg;\n      if (traceId) {\n        if (global.als) {\n          global.als.set('traceId', traceId);\n        }\n      }\n\n      return Promise.resolve()\n        .then(() => {\n          return actionMethod(msg);\n        })\n        .then((result) => {\n          return done(null, result);\n        })\n        .catch(Errors, (err) => {\n          logger.warn(err);\n          done(null, err.response());\n        })\n        .catch((err) => {\n          logger.error(err);\n          done(null, new Errors.Unknown().response());\n        });\n    };\n  });\n}\n"],"names":["wrapAct","seneca","Error","global","Errors","act","Promise","promisify","actAsync","msg","args","als","traceId","get","undefined","then","result","error","code","name","reject","wrapRoutes","plainMsg","_","omit","forEach","config","routes","action","key","index","indexOf","keyParts","slice","method","toLowerCase","includes","actionParts","split","controllerName","controller","controllers","actionMethodName","actionMethod","bind","actionAsync","done","set","resolve","catch","err","warn","response","Unknown"],"mappings":"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"}