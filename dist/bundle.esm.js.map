{"version":3,"file":"bundle.esm.js","sources":["../src/index.js"],"sourcesContent":["import _ from 'lodash';\nimport Promise from 'bluebird';\n\nexport function wrapAct() {\n  if (!this.seneca) {\n    throw new Error('no seneca found');\n  }\n\n  if (!global.Errors) {\n    throw new Error('no global Errors found');\n  }\n  let act = Promise.promisify(this.seneca.act, { context: this.seneca });\n\n  // expose global promise act\n  global.act = async function actAsync(...args) {\n    return act(...args).then((result) => {\n      if (result && result.errcode) {\n        if (!Errors[result.errcode]) {\n          return Promise.reject(new Error(`no error code found ${result.errcode}`));\n        }\n\n        return Promise.reject(new Errors[result.errcode]());\n      }\n      return result;\n    });\n  };\n}\n\nexport function wrapRoutes() {\n  if (!this.seneca) {\n    throw new Error('no seneca found');\n  }\n\n  this.seneca.plainMsg = function plainMsg(msg) {\n    return _.omit(msg, [\n      'cmd',\n      'action',\n      'role',\n      'transport$',\n      'id$',\n      'plugin$',\n      'fatal$',\n      'tx$',\n      'meta$',\n    ]);\n  };\n\n  _.forEach(this.config.routes, (action, key) => {\n    let index = key.indexOf(' ');\n    let keyParts = [key.slice(0, index), key.slice(index + 1)];\n    let method = (keyParts[0] || '').toLowerCase();\n\n    if (!_.includes(['add', 'wrap'], method)) {\n      throw new Error(`invalid route method: ${method}`);\n    }\n\n    let actionParts = action.split('.');\n    let controllerName = actionParts[0];\n    let controller = this.controllers[controllerName];\n    if (!controller) {\n      throw new Error(`undefined controller: ${controllerName}`);\n    }\n\n    let actionMethodName = actionParts[1];\n    let actionMethod = controller[actionMethodName].bind(controller);\n    if (!actionMethod) {\n      throw new Error(`undefined action method: ${action}`);\n    }\n\n    controller[actionMethodName] = function actionAsync(msg, done) {\n      let { traceId } = msg;\n      if (traceId) {\n        delete msg.traceId;\n        if (global.als) {\n          global.als.set('traceId', traceId);\n        }\n      }\n\n      return actionMethod(msg)\n        .then((result) => {\n          return done(null, result);\n        })\n        .catch(Errors.OperationalError, (err) => {\n          logger.warn(err);\n          done(null, err.response());\n        })\n        .catch((err) => {\n          logger.error(err);\n          done(null, new Errors.InternalError().response());\n        });\n    };\n  });\n}\n"],"names":["wrapAct","seneca","Error","global","Errors","act","Promise","promisify","actAsync","args","then","result","errcode","reject","wrapRoutes","plainMsg","msg","_","omit","forEach","config","routes","action","key","index","indexOf","keyParts","slice","method","toLowerCase","includes","actionParts","split","controllerName","controller","controllers","actionMethodName","actionMethod","bind","actionAsync","done","traceId","als","set","catch","OperationalError","err","warn","response","error","InternalError"],"mappings":"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"}