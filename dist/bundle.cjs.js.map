{"version":3,"file":"bundle.cjs.js","sources":["../src/index.js"],"sourcesContent":["import _ from 'lodash';\nimport Promise from 'bluebird';\n\nexport function wrapAct() {\n  if (!this.seneca) {\n    throw new Error('no seneca found');\n  }\n\n  if (!global.Errors) {\n    throw new Error('no global Errors found');\n  }\n  let act = Promise.promisify(this.seneca.act, { context: this.seneca });\n\n  // expose global promise act\n  global.act = async function actAsync(msg, ...args) {\n    if (global.als) {\n      let traceId = global.als.get('traceId');\n      msg.traceId = msg.traceId === undefined ? traceId : msg.traceId;\n    }\n\n    return act(msg, ...args).then((result) => {\n      if (result && result.errcode) {\n        if (!Errors[result.errcode]) {\n          return Promise.reject(new Error(`no error code found ${result.errcode}`));\n        }\n\n        return Promise.reject(new Errors[result.errcode]());\n      }\n      return result;\n    });\n  };\n}\n\nexport function wrapRoutes() {\n  if (!this.seneca) {\n    throw new Error('no seneca found');\n  }\n\n  this.seneca.plainMsg = function plainMsg(msg) {\n    return _.omit(msg, [\n      'cmd',\n      'action',\n      'role',\n      'transport$',\n      'id$',\n      'plugin$',\n      'fatal$',\n      'tx$',\n      'meta$',\n    ]);\n  };\n\n  _.forEach(this.config.routes, (action, key) => {\n    let index = key.indexOf(' ');\n    let keyParts = [key.slice(0, index), key.slice(index + 1)];\n    let method = (keyParts[0] || '').toLowerCase();\n\n    if (!_.includes(['add', 'wrap'], method)) {\n      throw new Error(`invalid route method: ${method}`);\n    }\n\n    let actionParts = action.split('.');\n    let controllerName = actionParts[0];\n    let controller = this.controllers[controllerName];\n    if (!controller) {\n      throw new Error(`undefined controller: ${controllerName}`);\n    }\n\n    let actionMethodName = actionParts[1];\n    let actionMethod = controller[actionMethodName].bind(controller);\n    if (!actionMethod) {\n      throw new Error(`undefined action method: ${action}`);\n    }\n\n    controller[actionMethodName] = function actionAsync(msg, done) {\n      let { traceId } = msg;\n      if (traceId) {\n        delete msg.traceId;\n        if (global.als) {\n          global.als.set('traceId', traceId);\n        }\n      }\n\n      return actionMethod(msg)\n        .then((result) => {\n          return done(null, result);\n        })\n        .catch(Errors.OperationalError, (err) => {\n          logger.warn(err);\n          done(null, err.response());\n        })\n        .catch((err) => {\n          logger.error(err);\n          done(null, new Errors.InternalError().response());\n        });\n    };\n  });\n}\n"],"names":["wrapAct","seneca","Error","global","Errors","act","Promise","promisify","actAsync","msg","args","als","traceId","get","undefined","then","result","errcode","reject","wrapRoutes","plainMsg","_","omit","forEach","config","routes","action","key","index","indexOf","keyParts","slice","method","toLowerCase","includes","actionParts","split","controllerName","controller","controllers","actionMethodName","actionMethod","bind","actionAsync","done","set","catch","OperationalError","err","warn","response","error","InternalError"],"mappings":"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"}